name: uptime

on:
  schedule:
    - cron: 0 * * * *

  push:
    branches:
      - main
    paths:
      - '.github/workflows/uptime.yaml'

      
permissions:
  contents: write
jobs:
    
  uptime:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: pip
                  
      - name: Install dependencies
        run: pip install httpx

      - name: Read previous uptime data
        continue-on-error: true
        uses: actions/download-artifact@v3     

      - name: Create uptime.md        
        run: |
          mkdir -p .github/uptime
          python .github/scripts/uptime.py .github/uptime/uptime.json .github/uptime/uptime.md
            
      - name: Commit & Push changes
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}              
          message: "[UPTIME] updating data"
          directory: .github/uptime

  mkdocs:
    runs-on: ubuntu-latest
    needs: ["uptime"]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: pip
      - run: pip install mkdocs-material mkdocs-minify-plugin      
      - name: Copy uptime.md
        run: cp .github/uptime/uptime.md docs/uptime.md
      - name: Run mkdocs
        run: mkdocs gh-deploy --force
